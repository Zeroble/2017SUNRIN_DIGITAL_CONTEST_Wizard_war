<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
    <!-- <script src="./skill.js"></script> -->
    <title>MCMT</title>
    <style>
        canvas {
            position: absolute;
            border: solid;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;

            margin: auto;
        }
    </style>
</head>

<body>
    매칭중
    <script>
        var socket = io.connect('/');
        let copyedUserObjects
        let mySkills = []
        let otherPlayerImg = new Image()
        const canvasWidth = 1200
        const canvasHeight = 450
        groundImage = new Image()
        groundImage.src = "./ground.png"
        window.onload = function () {
            socket.emit("matching")
        }
        socket.on('matching', (event) => {
            document.body.innerHTML = '로딩중'
            roomname = event.roomname
            if(event.player === 1){
                player = new Player('./player1.png',300)
                otherPlayerImg.src = './player2.png'
            }
            else{
                player = new Player('./player2.png',900)
                otherPlayerImg.src = './player1.png'
            }
            mouseClickedPoint = new mouseClickedPoint()
            points = new points()
            
            socket.emit("ready", {
                roomname: roomname,
                x: player.tempX,
                y: player.tempY,
                color: player.color,
            })
        })
        socket.on('ready', (event) => {
            document.body.innerHTML = '<canvas id="gameCanvas" width="'+canvasWidth+'" height="'+canvasHeight+'"></canvas>'
            document.body.background = './map_outer.png'
            // let clientXY = [screen.height-20,document.body.clientWidth]
            document.body.style.backgroundSize = '100%'
            canvas = document.getElementById('gameCanvas');
            context = canvas.getContext('2d');
            window.requestAnimationFrame(run);
        })
        var canvas
        var context
        var roomname

        const SPEED = 3
        class gameObject {
            constructor(width, height) {
                this.x = 0
                this.y = 0
                this.width = width
                this.height = height
            }
        }
        class Player extends gameObject {
            constructor(img,x) {
                super(16*3, 20*3)
                this.playerImg = new Image()
                this.playerImg.src = img
                this.x = x
                this.y = (canvasHeight-this.height)/2
                this.tempX = this.x
                this.tempY = this.y
                this.color = "#" + Math.floor(Math.random() * 9) + Math.floor(Math.random() * 9) + Math.floor(Math.random() * 9) + Math.floor(Math.random() * 9) + Math.floor(Math.random() * 9) + Math.floor(Math.random() * 9)
            }
        }
        class mouseClickedPoint {
            constructor() {
                this.x = player.tempX
                this.y = player.tempY
            }
        }
        class points {
            constructor() {
                this.atan2
                this.sin
                this.cos
                this.subx
                this.suby
            }
        }

        function stopMoving() {
            mouseClickedPoint.x = player.tempX
            mouseClickedPoint.y = player.tempY
        }
        function run() {
            context.drawImage(groundImage,0,0,canvas.width,canvas.height)   
            context.drawImage(player.playerImg,player.x,player.y,player.width,player.height)   

            points.subx = mouseClickedPoint.x - player.tempX
            points.suby = mouseClickedPoint.y - player.tempY
            points.atan2 = Math.atan2(points.subx, points.suby)
            points.sin = Math.sin(points.atan2)
            points.cos = Math.cos(points.atan2)

            for (let i in copyedUserObjects) {
                if (i == socket.id) {
                    player.x = copyedUserObjects[i].x
                    player.y = copyedUserObjects[i].y
                }
                else {
                    context.drawImage(otherPlayerImg,copyedUserObjects[i].x,copyedUserObjects[i].y,player.width,player.height)   
                }
            }
            if (points.subx > 0 ? player.tempX + points.sin * SPEED > mouseClickedPoint.x : player.tempX + points.sin * SPEED < mouseClickedPoint.x || points.suby >= 0 ? player.tempY + points.cos * SPEED > mouseClickedPoint.y : player.tempY + points.cos * SPEED < mouseClickedPoint.y) {
                //근처에 도달하면 정지
                stopMoving()
            }

            //     1
            //    ---
            // 2 ㅣ  ㅣ 3 
            //    ---
            //     4
            else if (player.tempX < 0) {
                player.tempX = 0
                stopMoving()
            }
            else if (player.tempX + player.width > canvas.width) {
                player.tempX = canvas.width - player.width
                stopMoving()
            }
            else if (player.tempY < 0) {
                player.tempY = 0
                stopMoving()
            }
            else if (player.tempY + player.height > canvas.height) {
                player.tempY = canvas.height - player.height
                stopMoving()
            }
            else {
                player.tempX += points.sin * SPEED
                player.tempY += points.cos * SPEED
                // console.log("moving")
            }
            if (player.tempX != mouseClickedPoint.x && player.tempY != mouseClickedPoint.y) {//움직이지 않을때
                socket.emit("update", {
                    x: player.tempX,
                    y: player.tempY,
                    roomname:roomname
                })
            }
            window.requestAnimationFrame(run);

        }
        socket.on('update', (userObjects) => {
            try {
                copyedUserObjects = JSON.parse(JSON.stringify(userObjects));
            } catch (error) {
                console.log(error)
            }
        })

        document.oncontextmenu = function () { return false; } //메뉴 뜨는거 방지
        window.addEventListener('keydown',function(event) {
            console.log(event)
            
            if(event.code === 'KeyQ'||event.code === 'KeyW'||event.code === 'KeyE'||event.code === 'KeyR'){
                document.body.style.cursor = 'crosshair'
            }
        })
        function getMousePosition(event) {//마우스 정확한 위치구하는 함수
            const rect = canvas.getBoundingClientRect()
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            }
        }
        window.addEventListener('mousedown', function (event) {
            if (event.button == 2) {//마우스 오른쪽 클릭시
                let pos = getMousePosition(event);
                mouseClickedPoint.x = pos.x - (player.width / 2)
                mouseClickedPoint.y = pos.y - (player.height / 2)
            }
            else if(event.button == 0){
                document.body.style.cursor = 'Auto'                
            }
        })
    </script>
</body>

</html>